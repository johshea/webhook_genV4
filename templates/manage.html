{% extends "base.html" %}
{% block content %}
<h1>Manage</h1>

<div class="tabs">
  <a class="tab {% if tab=='targets' %}active{% endif %}" href="{{ url_for('manage', tab='targets') }}">Targets</a>
  <a class="tab {% if tab=='functions' %}active{% endif %}" href="{{ url_for('manage', tab='functions') }}">Functions</a>
  {% if current_user.role == "admin" %}<a class="tab {% if tab=='users' %}active{% endif %}" href="{{ url_for('manage', tab='users') }}">Users</a>{% endif %}
</div>

{% if tab == 'targets' %}
  <h2>Webhook Targets</h2>
  {% if current_user.role == "admin" %}
  <form method="post" action="{{ url_for('create_target') }}">
    <div class="form-row">
      <div class="field">
        <label>Name</label>
        <input type="text" name="name" required>
      </div>
      <div class="field">
        <label>URL</label>
        <input type="text" name="url" required>
      </div>
    </div>
    <div class="button-row">
      <button class="btn" type="submit">Add Target</button>
    </div>
  </form>
  {% endif %}

  <table>
    <thead><tr><th>Name</th><th>URL</th><th>Actions</th></tr></thead>
    <tbody>
      {% for t in targets %}
      <tr>
        <td>{{ t.name }}</td>
        <td>{{ t.url }}</td>
        <td class="button-row">
          {% if current_user.role == "admin" %}
          <a class="btn small" href="{{ url_for('edit_target', target_id=t.id) }}">Edit</a>
          <form style="display:inline" method="post" action="{{ url_for('delete_target', target_id=t.id) }}">
            <button class="btn small danger" onclick="return confirm('Delete target {{t.name}}?')" type="submit">Delete</button>
          </form>
          {% else %}<span class="btn small secondary">view only</span>{% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% elif tab == 'functions' %}
  <h2>Functions</h2>
  {% if current_user.role == "admin" %}
  <form method="post" action="{{ url_for('create_function') }}">
    <div class="form-row">
      <div class="field">
        <label>Name</label>
        <input type="text" name="name" required>
      </div>
    </div>
    <div class="field">
      <label>JSON Template</label>
      <textarea name="json_template" placeholder='{"key":"value"}' required></textarea>
    </div>
    <div class="button-row">
      <button class="btn" type="submit">Add Function</button>
    </div>
  </form>
  {% endif %}

  <table>
    <thead><tr><th>Name</th><th>Template (snippet)</th><th>Actions</th></tr></thead>
    <tbody>
      {% for f in functions %}
      <tr>
        <td>{{ f.name }}</td>
        <td><code>{{ f.json_template[:120] }}{% if f.json_template|length > 120 %}...{% endif %}</code></td>
        <td class="button-row">
          {% if current_user.role == "admin" %}
          <a class="btn small" href="{{ url_for('edit_function', function_id=f.id) }}">Edit</a>
          <form style="display:inline" method="post" action="{{ url_for('delete_function', function_id=f.id) }}">
            <button class="btn small danger" onclick="return confirm('Delete function {{f.name}}?')" type="submit">Delete</button>
          </form>
          {% else %}<span class="btn small secondary">view only</span>{% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% elif tab == 'users' and current_user.role == 'admin' %}
  <h2>Users</h2>
  <form method="post" action="{{ url_for('create_user') }}">
    <div class="form-row">
      <div class="field">
        <label>Username</label>
        <input type="text" name="username" required>
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" name="password" required>
      </div>
      <div class="field">
        <label>Role</label>
        <select name="role">
          <option value="admin">admin</option>
          <option value="user">user</option>
          <option value="reviewer">reviewer</option>
        </select>
      </div>
    </div>
    <div class="button-row">
      <button class="btn" type="submit">Add User</button>
    </div>
  </form>

  <table>
    <thead><tr><th>Username</th><th>Role</th><th>Last Login</th><th>Actions</th></tr></thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td>{{ u.username }}</td>
        <td>{{ u.role }}</td>
        <td>{{ u.last_login or "" }}</td>
        <td class="button-row">
          <a class="btn small" href="{{ url_for('edit_user', user_id=u.id) }}">Edit</a>
          {% if u.id != current_user.id %}
          <form style="display:inline" method="post" action="{{ url_for('delete_user', user_id=u.id) }}">
            <button class="btn small danger" onclick="return confirm('Delete user {{u.username}}?')" type="submit">Delete</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}
{% endblock %}
